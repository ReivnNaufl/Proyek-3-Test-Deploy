<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- My Style -->
    <link rel="stylesheet" href="assets/css/qrcode.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <script defer src="assets/js/qrcode.js"></script>
  </head>

  <body>
    <!-- Sidebar Start -->
    <div class="sidebar">
      <div class="sidebar-icon">
        <button id="sidebar-toggle">
          <i data-feather="chevron-right"></i>
        </button>
      </div>
      <div class="sidebar-menu">
        <a href="#create" class="sidebar-link active"
          ><i data-feather="plus"></i> <span>Create New</span></a
        >
        <a href="index.html"><i data-feather="home"></i> <span>Home</span></a>
        <a href="#shortlink"
          ><i data-feather="link-2"></i> <span>URL Shortener</span></a
        >
        <a href="#qrcode"><i data-feather="grid"></i> <span>QR Codes</span></a>
        <a href="#linktree"
          ><i data-feather="trending-up"></i> <span>Link Tree</span></a
        >
      </div>
    </div>
    <!-- Sidebar End -->

    <!-- Navbar Start -->
    <nav class="top-navbar">
      <div class="user-dashboard">
        <p>User Dashboard</p>
      </div>
      <div class="user-profile">
        <div class="user-icon" id="user-icon">
          <i data-feather="smile"></i>
        </div>
        <div class="dropdown" id="dropdown">
          <a href="login.html">Logout</a>
        </div>
      </div>
    </nav>
    <!-- Navbar End -->

    <!-- Content Start -->
    <div class="content">
      <div class="qrcode-container">
        <nav class="tabs">
          <button
            class="tablinks"
            onclick="openTab(event, 'Create')"
            id="defaultOpen"
          >
            Create
          </button>
          <button class="tablinks" onclick="openTab(event, 'History')">
            History
          </button>
        </nav>

        <section id="Create" class="tabcontent">
          <h2>Create QR Code</h2>

          <div id="inputSection">
            <form id="qrForm" class="input-group">
              <label for="url">URL:</label>
              <input
                type="text"
                id="url"
                name="url"
                placeholder="Enter the URL..."
                required
              />

              <label for="title">Title:</label>
              <input
                type="text"
                id="title"
                name="title"
                placeholder="Enter the title..."
                required
              />

              <button type="submit" class="save-btn">Generate QR Code</button>
            </form>
          </div>

          <div id="resultSection" style="display: none">
            <div class="result-info">
              <p id="qrTitle" class="frozen-input"></p>
              <p id="qrUrl" class="frozen-input"></p>
            </div>

            <div class="result-container">
              <div class="qr-preview-section">
                <h3>QR Code Preview</h3>
                <div id="qrCodeContainer" class="preview"></div>

                <div class="action-buttons">
                  <button onclick="copyQRCode()" class="action-btn">
                    Copy QR
                  </button>
                  <button onclick="downloadQRCode()" class="action-btn">
                    Download QR
                  </button>
                  <button onclick="saveQRCode()" class="action-btn">
                    Save QR
                  </button>
                </div>
              </div>

              <div class="style-section">
                <div class="style-options">
                  <div class="options">
                    <h4>Color Style</h4>
                    <div class="color-options">
                      <div
                        class="color-option"
                        style="background-color: #e74c3c"
                        onclick="updateQRStyle('#e74c3c', this)"
                      ></div>
                      <div
                        class="color-option"
                        style="background-color: #e67e22"
                        onclick="updateQRStyle('#e67e22', this)"
                      ></div>
                      <div
                        class="color-option"
                        style="background-color: #3498db"
                        onclick="updateQRStyle('#3498db', this)"
                      ></div>
                      <div
                        class="color-option"
                        style="background-color: #2ecc71"
                        onclick="updateQRStyle('#2ecc71', this)"
                      ></div>
                      <input
                        type="color"
                        id="colorPicker"
                        class="color-picker"
                        value="#000000"
                        onchange="updateQRStyle(this.value, this)"
                      />
                    </div>
                  </div>

                  <div class="logo-section">
                    <h4>Update Logo</h4>
                    <input
                      type="file"
                      id="logo"
                      name="logo"
                      accept="image/*"
                      onchange="updateQRStyle(null, null, this)"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="History" class="tabcontent">
          <h3>History</h3>
          <div id="historyContainer">
            <div class="history-item">
              <i data-feather="link"></i>
              <div class="link-details">
                <p class="title">Example Title</p>
                <p class="url">https://example.com</p>
                <p><i data-feather="calendar"></i> 14 July 2024</p>
              </div>
              <div class="actions">
                <button onclick="copyHistoryQR(this)" class="save-btn">
                  <i data-feather="copy"></i> Copy
                </button>
                <button onclick="editHistoryQR(this)" class="save-btn">
                  <i data-feather="edit"></i> Edit
                </button>
                <button onclick="deleteHistoryQR(this)" class="save-btn">
                  <i data-feather="trash-2"></i> Delete
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <!-- Content End -->

    <!-- JavaScript -->
    <script src="assets/js/main.js"></script>
    <script src="assets/js/qrcode.js"></script>
    <script>
      let currentQRData = null;

      // Function to switch between tabs
      function openTab(evt, tabName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      // Handle form submission
      document
        .getElementById("qrForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          try {
            const response = await fetch("/generate-qr", {
              method: "POST",
              body: formData,
            });

            const data = await response.json();

            if (data.success) {
              currentQRData = data;
              displayQRResult(data);
              document.getElementById("inputSection").style.display = "none";
              document.getElementById("resultSection").style.display = "block";
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred. Please try again.");
          }
        });

      let currentQRStyle = {
        color: "#000000",
        logo: null,
      };

      function displayQRResult(data) {
        document.getElementById("qrTitle").textContent = "Title: " + data.title;
        document.getElementById("qrUrl").textContent = "URL: " + data.url;

        const img = document.createElement("img");
        img.src = data.imageData;
        img.alt = data.title;

        const container = document.getElementById("qrCodeContainer");
        container.innerHTML = "";
        container.appendChild(img);
      }

      async function updateQRStyle(
        color = null,
        element = null,
        logoInput = null
      ) {
        const formData = new FormData();
        formData.append("url", currentQRData.url);
        formData.append("title", currentQRData.title);

        if (color) {
          currentQRStyle.color = color;
          document
            .querySelectorAll(".color-option")
            .forEach((opt) => opt.classList.remove("selected"));
          if (element) element.classList.add("selected");
        }
        formData.append("color", currentQRStyle.color);

        if (logoInput && logoInput.files[0]) {
          currentQRStyle.logo = logoInput.files[0];
        }
        if (currentQRStyle.logo) {
          formData.append("logo", currentQRStyle.logo);
        }

        try {
          const response = await fetch("/generate-qr", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();
          if (data.success) {
            currentQRData = data;
            displayQRResult(data);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to update QR code style.");
        }
      }

      function copyQRCode() {
        if (currentQRData) {
          fetch(currentQRData.imageData)
            .then((res) => res.blob())
            .then((blob) => {
              const item = new ClipboardItem({ "image/png": blob });
              navigator.clipboard
                .write([item])
                .then(() => alert("QR Code copied to clipboard!"))
                .catch(() => alert("Failed to copy QR Code"));
            });
        }
      }

      function downloadQRCode() {
        if (currentQRData) {
          const a = document.createElement("a");
          a.href = currentQRData.imageData;
          a.download = `qr-code-${currentQRData.title}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }
      }

      function saveQRCode() {
        if (currentQRData) {
          // Save to local storage or database
          const historyItem = {
            title: currentQRData.title,
            url: currentQRData.url,
            imageData: currentQRData.imageData,
            date: new Date().toISOString(),
          };

          // Add to history (implementation depends on your storage method)
          saveToHistory(historyItem);
          alert("QR Code saved to history!");

          // Reset form for new input
          document.getElementById("qrForm").reset();
          document.getElementById("inputSection").style.display = "block";
          document.getElementById("resultSection").style.display = "none";
        }
      }

      // History Functions
      function editHistoryQR(button) {
        const historyItem = button.closest(".history-item");
        const title = historyItem.querySelector(".title").textContent;
        const url = historyItem.querySelector(".url").textContent;

        // Switch to Create tab
        document.getElementById("defaultOpen").click();

        // Fill form with history item data
        document.getElementById("url").value = url;
        document.getElementById("title").value = title;

        // Submit form to regenerate QR
        document.getElementById("qrForm").dispatchEvent(new Event("submit"));
      }

      function copyHistoryQR(button) {
        const historyItem = button.closest(".history-item");
        // Implementation depends on how you store the QR image data
        alert("QR Code copied to clipboard!");
      }

      function deleteHistoryQR(button) {
        const historyItem = button.closest(".history-item");
        if (confirm("Are you sure you want to delete this QR code?")) {
          historyItem.remove();
          // Also remove from storage
        }
      }

      // Initialize
      document.getElementById("defaultOpen").click();
      feather.replace();
    </script>
  </body>
</html>
